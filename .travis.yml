dist: trusty

addons:
  postgresql: 9.6
  sonarcloud:
    organization: "defra"

env:
  global:
    - CC_TEST_REPORTER_ID=40a6febb0a056fa9236dec7ffab8afc58cf5fd5973cad5f047fc14f32484203e
    - ENV_VARIABLE_TEST_FEATURE=true

language: ruby
rvm: 2.4.2
cache: bundler

# Travis CI uses shallow clone to speed up build times, but a truncated SCM
# history may cause issues when SonarCloud computes blame data. To avoid this,
# you can access the full SCM history with `depth: false`
git:
  depth: false

before_install:
  - export TZ=UTC
  - gem install -v 1.17.3 bundler --no-rdoc --no-ri
  - sudo apt-get install xvfb -y
  - sudo apt-get install ttf-liberation -y
  - sudo apt-get install wkhtmltopdf -y

before_script:
  # Replace database.yml with database.travis.yml (but leave filename as
  # database.yml). database.travis.yml is the config needed for Travis, and it
  # needs to be in place before we run the migrations.
  - cp spec/dummy/config/database.travis.yml spec/dummy/config/database.yml
  - RAILS_ENV=test bundle exec rake db:create --trace
  - RAILS_ENV=test bundle exec rake db:migrate --trace

script:
  - bundle exec rubocop --format=json --out=rubocop-result.json
  - bundle exec rspec
  - sonar-scanner
